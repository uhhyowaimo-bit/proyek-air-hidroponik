<!-- templates/index.html -->
<!DOCTYPE html>
<html>
<head>
    <title>üíß Monitor Hidroponik</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .status-box { padding: 20px; border-radius: 10px; color: white; text-align: center; font-weight: bold; }
        .recommendation { margin-top: 15px; padding: 12px; border-radius: 8px; }
        .chart-container { height: 300px; margin-top: 20px; }
        .download-btn { margin-top: 20px; }
        .prediction-section { margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; }
    </style>
</head>
<body class="bg-light">
    <div class="container py-4">
        <h1 class="text-center mb-4">üíß Sistem Monitor Air Hidroponik</h1>
        
        <!-- Real-time Data Cards -->
        <div class="row text-center mb-4">
            <div class="col-12 col-md-4 mb-3">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="text-muted">TDS Saat Ini</h5>
                        <h3 id="tds-value">--</h3>
                        <small class="text-muted">ppm</small>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-4 mb-3">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="text-muted">EC</h5>
                        <h3 id="ec-value">--</h3>
                        <small class="text-muted">mS/cm</small>
                    </div>
                </div>
            </div>
            <div class="col-12 col-md-4 mb-3">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5 class="text-muted">Suhu</h5>
                        <h3 id="temp-value">--</h3>
                        <small class="text-muted">¬∞C</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Box -->
        <div class="text-center mb-4">
            <div id="status-box" class="status-box bg-secondary">Memuat...</div>
            <div id="recommendation" class="recommendation bg-light text-dark">Menunggu data...</div>
        </div>

        <!-- Chart -->
        <div class="chart-container">
            <canvas id="sensorChart"></canvas>
        </div>

        <!-- Download Button -->
        <div class="text-center download-btn">
            <a href="/static/predictor.zip" class="btn btn-outline-primary">
                üì• Download Aplikasi Prediksi (LSTM/ARIMA Offline)
            </a>
            <p class="mt-2 small text-muted">
                Jalankan di PC Anda untuk prediksi berbasis data microSD.
            </p>
        </div>

        <!-- Prediction Section (Auto-loaded from offline app) -->
        <div class="prediction-section">
            <h5>üìà Prediksi Kualitas Air (Dari Aplikasi Offline)</h5>
            <div id="prediction-result" class="alert alert-info">
                Belum ada prediksi. Jalankan aplikasi prediksi di PC Anda.
            </div>
        </div>

        <!-- Petunjuk -->
        <div class="alert alert-info small mt-4">
            <strong>‚ÑπÔ∏è Panduan Status:</strong><br>
            <span class="text-success">üü¢ BAIK</span>: Air ideal untuk tanaman.<br>
            <span class="text-warning">üü° SEDANG</span>: Periksa nutrisi atau suhu.<br>
            <span class="text-danger">üî¥ BURUK</span>: Segera lakukan tindakan!
        </div>
    </div>

    <script>
        // Inisialisasi chart
        const ctx = document.getElementById('sensorChart').getContext('2d');
        let sensorChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'TDS (ppm)',
                        data: [],
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        fill: false,
                        tension: 0.3
                    },
                    {
                        label: 'EC (mS/cm)',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        fill: false,
                        tension: 0.3
                    },
                    {
                        label: 'Suhu (¬∞C)',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        fill: false,
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                },
                scales: {
                    x: { display: true, title: { display: true, text: 'Waktu (Terakhir 10 Titik)' } },
                    y: { beginAtZero: false }
                }
            }
        });

        let chartData = { tds: [], ec: [], temp: [], labels: [] };

        // Ambil data real-time dari sensor
        async function updateRealtimeData() {
            try {
                const res = await fetch('/api/latest');
                const data = await res.json();
                if (data.error) {
                    document.getElementById('status-box').innerText = "Belum ada data";
                    document.getElementById('recommendation').innerText = "Pastikan sensor aktif.";
                    return;
                }

                document.getElementById('tds-value').innerText = data.tds.toFixed(0);
                document.getElementById('ec-value').innerText = data.ec.toFixed(2);
                document.getElementById('temp-value').innerText = data.temp.toFixed(1);

                const statusBox = document.getElementById('status-box');
                const recBox = document.getElementById('recommendation');

                statusBox.innerText = `Status: ${data.status}`;
                statusBox.className = `status-box bg-${data.bootstrap_color}`;

                recBox.innerText = data.recommendation;
                recBox.className = `recommendation bg-${data.bootstrap_color}-subtle text-${data.bootstrap_color}`;

                // Update chart
                const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                chartData.labels.push(now);
                chartData.tds.push(data.tds);
                chartData.ec.push(data.ec);
                chartData.temp.push(data.temp);

                if (chartData.labels.length > 10) {
                    chartData.labels.shift();
                    chartData.tds.shift();
                    chartData.ec.shift();
                    chartData.temp.shift();
                }

                sensorChart.data.labels = chartData.labels;
                sensorChart.data.datasets[0].data = chartData.tds;
                sensorChart.data.datasets[1].data = chartData.ec;
                sensorChart.data.datasets[2].data = chartData.temp;
                sensorChart.update();
            } catch (e) {
                console.error("Gagal muat data real-time:", e);
            }
        }

        // Ambil hasil prediksi dari aplikasi offline
        async function loadPrediction() {
            try {
                const res = await fetch('/api/prediction');
                const data = await res.json();
                const predDiv = document.getElementById('prediction-result');

                if (data.error) {
                    predDiv.innerHTML = `
                        Belum ada prediksi. <br>
                        <small class="text-muted">Jalankan aplikasi prediksi di PC Anda.</small>
                    `;
                } else {
                    const forecast = data.forecast.map(v => v.toFixed(0)).join(', ');
                    predDiv.innerHTML = `
                        <strong>üìä Prediksi TDS 6 Jam ke Depan:</strong><br>
                        ${forecast}<br>
                        <small class="text-muted">Diupdate: ${new Date(data.timestamp).toLocaleString()}</small>
                    `;
                }
            } catch (e) {
                console.error("Gagal muat prediksi:", e);
            }
        }

        // Update otomatis
        setInterval(updateRealtimeData, 5000);
        setInterval(loadPrediction, 10000); // Cek prediksi tiap 10 detik

        // Jalankan sekali saat halaman dibuka
        updateRealtimeData();
        loadPrediction();
    </script>
</body>
</html>